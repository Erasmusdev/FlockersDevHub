name: Discord Update Notification

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed-files
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD^..HEAD | head -n 10 | sed 's/^/`/' | sed 's/$/`/' | paste -sd ',' - | sed 's/,/, /g')
          if [ -z "$CHANGED_FILES" ]; then
            CHANGED_FILES="No files changed"
          fi
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT

      - name: Send Discord Notification
        run: |
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | sed 's/"/\\"/g' | head -c 1000)
          AUTHOR="${{ github.event.head_commit.author.name }}"
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA=${SHORT_SHA:0:7}
          
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"embeds\": [{
                 \"title\": \"ğŸš€ FlockersDevHub Updated\",
                 \"description\": \"New changes have been pushed to the website\",
                 \"color\": 65475,
                 \"fields\": [
                   {\"name\": \"ğŸ“ Commit Message\", \"value\": \"${COMMIT_MSG}\"},
                   {\"name\": \"ğŸ‘¤ Author\", \"value\": \"${AUTHOR}\", \"inline\": true},
                   {\"name\": \"ğŸŒ¿ Branch\", \"value\": \"${{ github.ref_name }}\", \"inline\": true},
                   {\"name\": \"ğŸ“¦ Commit\", \"value\": \"[\`${SHORT_SHA}\`](${{ github.event.head_commit.url }})\", \"inline\": true},
                   {\"name\": \"ğŸ“‚ Changed Files\", \"value\": \"${{ steps.changed-files.outputs.files }}\"},
                   {\"name\": \"ğŸŒ Live Site\", \"value\": \"[Visit FlockersDevHub](https://erasmusdev.github.io/FlockersDevHub)\"}
                 ],
                 \"thumbnail\": {
                   \"url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\"
                 },
                 \"footer\": {
                   \"text\": \"GitHub Actions\"
                 },
                 \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
               }]}" \
               "${{ secrets.WEBHOOK }}"
