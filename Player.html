<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Now Playing Widget</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #121212;
            color: #fff;
            margin: 0;
            overflow: hidden;
        }

        .widget-container {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50px; /* Use a large value for a pill shape */
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            padding: 10px 20px; /* Smaller padding for a compact look */
            text-align: left; /* Align content to the left */
            display: flex; /* Use flexbox for horizontal layout */
            align-items: center;
            gap: 15px; /* Space between album art and text */
            max-width: 350px;
            width: 90%;
            transition: all 0.3s ease;
        }
        
        /* Specific styling for the login-only state */
        .widget-container.login-state {
            text-align: center;
            padding: 20px;
            border-radius: 20px;
            display: block;
        }

        #login-button {
            background-color: #1ed760;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 500px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        #login-button:hover {
            background-color: #1ab24e;
            transform: translateY(-1px);
        }
        
        #login-section p {
            font-size: 0.95em;
            color: #b0b0b0;
            margin-bottom: 25px;
        }

        #now-playing {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
            display: flex; /* Always use flexbox for this section */
            align-items: center;
            width: 100%;
            gap: 15px;
        }

        #now-playing.visible {
            opacity: 1;
        }
        
        #now-playing > * {
            flex-shrink: 0; /* Prevent children from shrinking */
        }
        
        #album-art {
            width: 48px; /* Small square album art */
            height: 48px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            object-fit: cover;
            flex-shrink: 0;
        }

        .track-info {
            display: flex;
            flex-direction: column;
            text-align: left;
            overflow: hidden; /* Hide overflowing text */
            flex-grow: 1; /* Allow this container to grow and fill space */
            white-space: nowrap; /* Prevent all content inside from wrapping */
        }

        #track-title {
            font-size: 1em;
            font-weight: 600;
            margin: 0;
            color: #ffffff;
            text-overflow: ellipsis; /* Add ellipsis for long titles */
        }

        #artist-name {
            font-size: 0.85em;
            color: #b0b0b0;
            margin: 0;
            text-overflow: ellipsis;
        }

    </style>
</head>
<body>

    <div class="widget-container login-state" id="main-widget-container">
        <div id="login-section">
            <p>To see what you're listening to, please log in to Spotify.</p>
            <a href="#" id="login-button">Log in with Spotify</a>
        </div>

        <div id="now-playing">
            <img id="album-art" src="" alt="Album Art">
            <div class="track-info">
                <p id="track-title"></p>
                <p id="artist-name"></p>
            </div>
        </div>
    </div>

    <script>
        const clientId = 'd6d3071a35dc4874af1dcf110017ec8d'; // YOUR CLIENT ID HERE
        const redirectUri = 'https://erasmusdev.github.io/FlockersDevHub/Player.html'; // YOUR GITHUB PAGES URL HERE
        const authEndpoint = 'https://accounts.spotify.com/authorize';
        const tokenEndpoint = 'https://accounts.spotify.com/api/token';
        const scope = 'user-read-currently-playing';

        const mainWidgetContainer = document.getElementById('main-widget-container');
        const loginSection = document.getElementById('login-section');
        const nowPlayingSection = document.getElementById('now-playing');
        const trackTitle = document.getElementById('track-title');
        const artistName = document.getElementById('artist-name');
        const albumArt = document.getElementById('album-art');
        const loginButton = document.getElementById('login-button');

        // Function to generate a random string for the code verifier
        const generateRandomString = (length) => {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let text = '';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        };

        // Function to generate a code challenge from the code verifier
        const generateCodeChallenge = async (codeVerifier) => {
            const encoder = new TextEncoder();
            const data = encoder.encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        };

        const urlParams = new URLSearchParams(window.location.search);
        let code = urlParams.get('code');

        if (code) {
            getAccessToken(code);
        } else {
            let accessToken = localStorage.getItem('accessToken');
            
            if (accessToken) {
                mainWidgetContainer.classList.remove('login-state'); // Remove login-specific styling
                loginSection.style.display = 'none';
                nowPlayingSection.style.display = 'flex'; // Use flex for this layout
                nowPlayingSection.classList.add('visible'); // Add visible class for fade-in
                getCurrentlyPlaying();
                setInterval(getCurrentlyPlaying, 5000); 
            } else {
                loginButton.addEventListener('click', async () => {
                    const verifier = generateRandomString(128);
                    const challenge = await generateCodeChallenge(verifier);

                    localStorage.setItem('code_verifier', verifier);

                    const params = new URLSearchParams({
                        client_id: clientId,
                        response_type: 'code',
                        redirect_uri: redirectUri,
                        scope: scope,
                        code_challenge_method: 'S256',
                        code_challenge: challenge,
                    });

                    window.location.href = `${authEndpoint}?${params.toString()}`;
                });
            }
        }

        async function getAccessToken(authCode) {
            const verifier = localStorage.getItem('code_verifier');
            const body = new URLSearchParams({
                grant_type: 'authorization_code',
                code: authCode,
                redirect_uri: redirectUri,
                client_id: clientId,
                code_verifier: verifier,
            });

            try {
                const response = await fetch(tokenEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: body,
                });

                if (!response.ok) {
                    throw new Error('HTTP status ' + response.status);
                }

                const data = await response.json();
                localStorage.setItem('accessToken', data.access_token);
                localStorage.setItem('refreshToken', data.refresh_token);
                window.history.replaceState({}, document.title, redirectUri); // Clean up the URL
                location.reload(); 
            } catch (error) {
                console.error('Error fetching access token:', error);
            }
        }

        async function getCurrentlyPlaying() {
            let accessToken = localStorage.getItem('accessToken');
            if (!accessToken) {
                localStorage.clear();
                location.reload();
                return;
            }

            try {
                const response = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                if (response.status === 204) {
                    mainWidgetContainer.classList.add('login-state');
                    loginSection.style.display = 'block';
                    nowPlayingSection.style.display = 'none';
                    trackTitle.innerText = "Nothing playing right now.";
                    artistName.innerText = "";
                    albumArt.style.display = "none";
                    return;
                }

                if (response.status === 401) {
                    localStorage.clear();
                    location.reload(); 
                    return;
                }

                const data = await response.json();
                if (data.item) {
                    mainWidgetContainer.classList.remove('login-state');
                    loginSection.style.display = 'none';
                    nowPlayingSection.style.display = 'flex';
                    nowPlayingSection.classList.add('visible');
                    trackTitle.innerText = data.item.name;
                    artistName.innerText = data.item.artists.map(artist => artist.name).join(', ');
                    albumArt.src = data.item.album.images[0].url;
                    albumArt.style.display = "block";
                } else {
                    mainWidgetContainer.classList.add('login-state');
                    loginSection.style.display = 'block';
                    nowPlayingSection.style.display = 'none';
                    trackTitle.innerText = "Nothing playing right now.";
                    artistName.innerText = "";
                    albumArt.style.display = "none";
                }
            } catch (error) {
                console.error("Error fetching currently playing track:", error);
            }
        }
    </script>
</body>
</html>