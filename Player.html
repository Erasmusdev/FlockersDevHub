<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Now Playing Widget</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #121212;
            color: #fff;
        }

        .widget-container {
            background-color: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        #login-button {
            background-color: #1db954;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 500px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        #now-playing {
            display: none;
        }

        #album-art {
            width: 150px;
            height: 150px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        #track-title {
            font-size: 1.5em;
            font-weight: bold;
        }

        #artist-name {
            font-size: 1.2em;
            color: #b3b3b3;
        }
    </style>
</head>
<body>

    <div class="widget-container">
        <div id="login-section">
            <p>To see what you're listening to, please log in to Spotify.</p>
            <a href="#" id="login-button">Log in with Spotify</a>
        </div>

        <div id="now-playing">
            <img id="album-art" src="" alt="Album Art">
            <p id="track-title"></p>
            <p id="artist-name"></p>
        </div>
    </div>

    <script>
        const clientId = 'd6d3071a35dc4874af1dcf110017ec8d'; // REPLACE WITH YOUR CLIENT ID
        const redirectUri = 'https://erasmusdev.github.io/FlockersDevHub/Player.html';
        const authEndpoint = 'https://accounts.spotify.com/authorize';
        const tokenEndpoint = 'https://accounts.spotify.com/api/token';
        const scope = 'user-read-currently-playing';

        const loginSection = document.getElementById('login-section');
        const nowPlayingSection = document.getElementById('now-playing');
        const trackTitle = document.getElementById('track-title');
        const artistName = document.getElementById('artist-name');
        const albumArt = document.getElementById('album-art');
        const loginButton = document.getElementById('login-button');

        // Function to generate a random string for the code verifier
        const generateRandomString = (length) => {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let text = '';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        };

        // Function to generate a code challenge from the code verifier
        const generateCodeChallenge = async (codeVerifier) => {
            const encoder = new TextEncoder();
            const data = encoder.encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        };

        const urlParams = new URLSearchParams(window.location.search);
        let code = urlParams.get('code');

        if (code) {
            getAccessToken(code);
        } else {
            let accessToken = localStorage.getItem('accessToken');
            
            if (accessToken) {
                loginSection.style.display = 'none';
                nowPlayingSection.style.display = 'block';
                getCurrentlyPlaying();
                setInterval(getCurrentlyPlaying, 5000); 
            } else {
                loginButton.addEventListener('click', async () => {
                    const verifier = generateRandomString(128);
                    const challenge = await generateCodeChallenge(verifier);

                    localStorage.setItem('code_verifier', verifier);

                    const params = new URLSearchParams({
                        client_id: clientId,
                        response_type: 'code',
                        redirect_uri: redirectUri,
                        scope: scope,
                        code_challenge_method: 'S256',
                        code_challenge: challenge,
                    });

                    window.location.href = `${authEndpoint}?${params.toString()}`;
                });
            }
        }

        async function getAccessToken(authCode) {
            const verifier = localStorage.getItem('code_verifier');
            const body = new URLSearchParams({
                grant_type: 'authorization_code',
                code: authCode,
                redirect_uri: redirectUri,
                client_id: clientId,
                code_verifier: verifier,
            });

            try {
                const response = await fetch(tokenEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: body,
                });

                if (!response.ok) {
                    throw new Error('HTTP status ' + response.status);
                }

                const data = await response.json();
                localStorage.setItem('accessToken', data.access_token);
                localStorage.setItem('refreshToken', data.refresh_token);
                window.history.replaceState({}, document.title, redirectUri); // Clean up the URL
                location.reload(); 
            } catch (error) {
                console.error('Error fetching access token:', error);
            }
        }

        async function getCurrentlyPlaying() {
            let accessToken = localStorage.getItem('accessToken');
            if (!accessToken) {
                // No token, or token expired and not refreshed, show login button
                localStorage.clear();
                location.reload();
                return;
            }

            try {
                const response = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                if (response.status === 204) {
                    trackTitle.innerText = "Nothing playing right now.";
                    artistName.innerText = "";
                    albumArt.style.display = "none";
                    return;
                }

                if (response.status === 401) {
                    // Token expired or invalid, clear and force re-login
                    localStorage.clear();
                    location.reload(); 
                    return;
                }

                const data = await response.json();
                if (data.item) {
                    trackTitle.innerText = data.item.name;
                    artistName.innerText = data.item.artists.map(artist => artist.name).join(', ');
                    albumArt.src = data.item.album.images[0].url;
                    albumArt.style.display = "block";
                } else {
                    trackTitle.innerText = "Nothing playing right now.";
                    artistName.innerText = "";
                    albumArt.style.display = "none";
                }
            } catch (error) {
                console.error("Error fetching currently playing track:", error);
            }
        }
    </script>
</body>
</html>