<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spotify Now Playing Widget</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

    body {
      font-family: 'Poppins', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: transparent;
      color: #fff;
      margin: 0;
      overflow: hidden;
    }

    .widget-container {
      background: #111;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
      padding: 20px;
      text-align: left;
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-width: 350px;
      min-width: 300px;
      width: 90%;
      transition: all 0.3s ease;
    }

    .widget-container.login-state {
      padding: 30px;
      gap: 20px;
    }

    .widget-header {
      font-size: 1.8em;
      font-weight: 700;
      color: #fff;
      margin-bottom: 5px;
      line-height: 1.2;
    }

    .widget-subheader {
      font-size: 1em;
      font-weight: 400;
      color: #b0b0b0;
      margin-bottom: 15px;
    }

    .button-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
    }

    .action-button {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      text-align: center;
      transition: background-color 0.2s ease, transform 0.2s ease;
      font-size: 0.9em;
    }

    #login-button, #setup-button {
      background-color: #ffd44c;
      color: #111;
    }
    #login-button:hover, #setup-button:hover {
      background-color: #ffc820;
      transform: translateY(-1px);
    }

    .secondary-button {
      background-color: #4b6791;
      color: white;
    }
    .secondary-button:hover {
      background-color: #5d78a1;
      transform: translateY(-1px);
    }

    #setup-section input[type="text"] {
      width: calc(100% - 20px);
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #333;
      border-radius: 6px;
      background-color: #222;
      color: white;
      font-size: 0.9em;
    }

    .small-link {
      font-size: 0.8em;
      color: #999;
      text-decoration: underline;
      margin-top: 10px;
      text-align: center;
      cursor: pointer;
    }

    #now-playing {
      opacity: 0;
      transition: opacity 0.5s ease;
      display: flex;
      align-items: center;
      gap: 15px;
      min-width: 0;
    }

    #now-playing.visible {
      opacity: 1;
    }

    #album-art {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
    }

    .track-info {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex-grow: 1;
      min-width: 0;
    }

    #track-title, #artist-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin: 0;
    }

    #track-title {
      font-size: 1.1em;
      font-weight: 600;
      color: #fff;
    }

    #artist-name {
      font-size: 0.9em;
      color: #b0b0b0;
    }

    #logout-button {
      display: none;
      margin-left: auto;
    }
  </style>
</head>
<body>
  <div class="widget-container login-state" id="main-widget-container">
    <div id="setup-section" style="display: none;">
      <p class="widget-header">Spotify Player Setup</p>
      <p class="widget-subheader">Enter your Client ID & Redirect URI</p>
      <input type="text" id="client-id-input" placeholder="Your Spotify Client ID" required />
      <input type="text" id="redirect-uri-input" placeholder="Your Redirect URI" required />
      <div class="button-group">
        <button id="setup-button" class="action-button">Save & Continue</button>
        <a href="https://developer.spotify.com/dashboard/applications" target="_blank" class="action-button secondary-button">Developer Hub</a>
      </div>
      <p class="small-link" id="clear-data-button">Clear All Stored Data</p>
    </div>

    <div id="login-section" style="display: none;">
      <p class="widget-header">Connect Spotify</p>
      <p class="widget-subheader">One-time login required</p>
      <div class="button-group">
        <a href="#" id="login-button" class="action-button">Log in with Spotify</a>
        <span id="reconfigure-button" class="action-button secondary-button" style="cursor: pointer;">Re-enter Client Details</span>
      </div>
    </div>

    <div id="now-playing">
      <img id="album-art" src="https://via.placeholder.com/60" alt="Album Art" />
      <div class="track-info">
        <p id="track-title" class="widget-header" style="font-size: 1.1em;"></p>
        <p id="artist-name" class="widget-subheader" style="margin-bottom: 0;"></p>
      </div>
      <button id="logout-button" class="action-button secondary-button">Logout</button>
    </div>
  </div>

  <script>
    const authEndpoint = 'https://accounts.spotify.com/authorize';
    const tokenEndpoint = 'https://accounts.spotify.com/api/token';
    const currentlyPlayingEndpoint = 'https://api.spotify.com/v1/me/player/currently-playing';
    const scope = 'user-read-currently-playing';

    const setupSection = document.getElementById('setup-section');
    const loginSection = document.getElementById('login-section');
    const nowPlayingSection = document.getElementById('now-playing');
    const trackTitle = document.getElementById('track-title');
    const artistName = document.getElementById('artist-name');
    const albumArt = document.getElementById('album-art');
    const loginButton = document.getElementById('login-button');
    const setupButton = document.getElementById('setup-button');
    const reconfigureButton = document.getElementById('reconfigure-button');
    const clearDataButton = document.getElementById('clear-data-button');
    const logoutButton = document.getElementById('logout-button');
    const clientIdInput = document.getElementById('client-id-input');
    const redirectUriInput = document.getElementById('redirect-uri-input');

    let clientId = localStorage.getItem('spotifyClientId');
    let redirectUri = localStorage.getItem('spotifyRedirectUri');
    let accessToken = localStorage.getItem('accessToken');
    let refreshToken = localStorage.getItem('refreshToken');

    const generateRandomString = (length) => {
      const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      return Array.from(crypto.getRandomValues(new Uint8Array(length))).map(x => possible[x % possible.length]).join('');
    };

    const generateCodeChallenge = async (verifier) => {
      const data = new TextEncoder().encode(verifier);
      const digest = await crypto.subtle.digest('SHA-256', data);
      return btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    };

    function showSetup() {
      setupSection.style.display = 'block';
      loginSection.style.display = 'none';
      nowPlayingSection.style.display = 'none';
    }

    function showLogin() {
      setupSection.style.display = 'none';
      loginSection.style.display = 'block';
      nowPlayingSection.style.display = 'none';
    }

    function showNowPlaying() {
      setupSection.style.display = 'none';
      loginSection.style.display = 'none';
      nowPlayingSection.style.display = 'flex';
      nowPlayingSection.classList.add('visible');
      logoutButton.style.display = 'inline-block';
    }

    async function getAccessToken(code) {
      const verifier = localStorage.getItem('code_verifier');
      const body = new URLSearchParams({
        grant_type: 'authorization_code',
        code: code,
        redirect_uri: redirectUri,
        client_id: clientId,
        code_verifier: verifier,
      });
      try {
        const response = await fetch(tokenEndpoint, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body });
        const data = await response.json();
        accessToken = data.access_token;
        refreshToken = data.refresh_token;
        localStorage.setItem('accessToken', accessToken);
        localStorage.setItem('refreshToken', refreshToken);
        window.history.replaceState({}, document.title, redirectUri);
        location.reload();
      } catch (err) {
        console.error('Token error', err);
        showLogin();
      }
    }

    async function refreshAccessToken() {
      if (!refreshToken) return false;
      const body = new URLSearchParams({
        grant_type: 'refresh_token',
        refresh_token: refreshToken,
        client_id: clientId,
      });
      try {
        const response = await fetch(tokenEndpoint, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body });
        const data = await response.json();
        accessToken = data.access_token;
        localStorage.setItem('accessToken', accessToken);
        if (data.refresh_token) {
          refreshToken = data.refresh_token;
          localStorage.setItem('refreshToken', refreshToken);
        }
        return true;
      } catch (err) {
        console.error('Refresh error', err);
        return false;
      }
    }

    async function getCurrentlyPlaying() {
      if (!accessToken) return showLogin();
      try {
        let response = await fetch(currentlyPlayingEndpoint, { headers: { Authorization: 'Bearer ' + accessToken } });
        if (response.status === 401) {
          const refreshed = await refreshAccessToken();
          if (!refreshed) return showLogin();
          response = await fetch(currentlyPlayingEndpoint, { headers: { Authorization: 'Bearer ' + accessToken } });
        }
        if (response.status === 204) {
          showNowPlaying();
          trackTitle.textContent = 'Nothing playing';
          artistName.textContent = 'Start a song on Spotify';
          albumArt.style.display = 'none';
          return;
        }
        const data = await response.json();
        if (data.item) {
          showNowPlaying();
          trackTitle.textContent = data.item.name;
          artistName.textContent = data.item.artists.map(a => a.name).join(', ');
          albumArt.src = data.item.album.images[0].url;
          albumArt.style.display = 'block';
        }
      } catch (err) {
        console.error('Fetch error', err);
        trackTitle.textContent = 'Error';
        artistName.textContent = 'Reconnect required';
        albumArt.style.display = 'none';
      }
    }

    setupButton.onclick = () => {
      clientId = clientIdInput.value.trim();
      redirectUri = redirectUriInput.value.trim();
      if (!clientId || !redirectUri) return alert('Both fields required');
      localStorage.setItem('spotifyClientId', clientId);
      localStorage.setItem('spotifyRedirectUri', redirectUri);
      showLogin();
    };

    loginButton.onclick = async (e) => {
      e.preventDefault();
      const verifier = generateRandomString(128);
      const challenge = await generateCodeChallenge(verifier);
      localStorage.setItem('code_verifier', verifier);
      const params = new URLSearchParams({
        client_id: clientId,
        response_type: 'code',
        redirect_uri: redirectUri,
        scope,
        code_challenge_method: 'S256',
        code_challenge: challenge,
      });
      window.location = `${authEndpoint}?${params}`;
    };

    reconfigureButton.onclick = () => {
      localStorage.removeItem('spotifyClientId');
      localStorage.removeItem('spotifyRedirectUri');
      showSetup();
    };

    clearDataButton.onclick = () => {
      if (confirm('Clear all data?')) {
        localStorage.clear();
        location.reload();
      }
    };

    logoutButton.onclick = () => {
      if (confirm('Log out from Spotify?')) {
        localStorage.clear();
        location.reload();
      }
    };

    const params = new URLSearchParams(location.search);
    if (params.get('code')) {
      getAccessToken(params.get('code'));
    } else if (accessToken) {
      getCurrentlyPlaying();
      setInterval(getCurrentlyPlaying, 5000);
    } else if (clientId && redirectUri) {
      showLogin();
    } else {
      showSetup();
    }
  </script>
</body>
</html>