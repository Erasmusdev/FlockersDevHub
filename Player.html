<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Now Playing Widget - Modern Glass</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif; /* Modern font */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #1d2127 0%, #0d0f12 100%); /* Darker, subtle gradient */
            color: #e0e0e0; /* Lighter text for contrast */
            margin: 0;
            overflow: hidden; /* Prevent scrollbars */
        }

        .widget-container {
            background: rgba(255, 255, 255, 0.08); /* Semi-transparent background */
            backdrop-filter: blur(15px) saturate(180%); /* Frosted glass effect */
            -webkit-backdrop-filter: blur(15px) saturate(180%); /* For Safari */
            border: 1px solid rgba(255, 255, 255, 0.1); /* Subtle white border */
            border-radius: 20px; /* More rounded corners */
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); /* Stronger, diffused shadow */
            padding: 25px 35px; /* Increased padding */
            text-align: center;
            max-width: 320px; /* Max width for a compact widget */
            width: 90%; /* Responsive width */
            transition: all 0.3s ease; /* Smooth transitions for hover effects */
        }

        .widget-container:hover {
            box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.45); /* Slightly more prominent shadow on hover */
            transform: translateY(-2px); /* Slight lift effect */
        }

        #login-button {
            background-color: #1ed760; /* Spotify green */
            color: white;
            padding: 12px 25px; /* Larger button */
            border: none;
            border-radius: 500px;
            font-weight: 600; /* Bolder font weight */
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.2s ease, transform 0.2s ease; /* Smooth hover */
        }

        #login-button:hover {
            background-color: #1ab24e; /* Darker green on hover */
            transform: translateY(-1px);
        }

        #login-section p {
            font-size: 0.95em;
            color: #b0b0b0; /* Subtler text */
            margin-bottom: 25px;
        }

        #now-playing {
            display: none;
            opacity: 0; /* Start hidden for fade-in */
            transition: opacity 0.5s ease; /* Fade-in effect */
        }

        #now-playing.visible {
            opacity: 1; /* Make visible */
        }

        #album-art {
            width: 160px; /* Slightly larger album art */
            height: 160px;
            border-radius: 12px; /* More rounded album art */
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25); /* Shadow for album art */
            object-fit: cover; /* Ensure image covers the area */
        }

        #track-title {
            font-size: 1.6em; /* Slightly larger title */
            font-weight: 700; /* Bold title */
            margin-bottom: 5px;
            color: #ffffff; /* Pure white title */
            white-space: nowrap; /* Prevent title from wrapping prematurely */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Add ellipsis for long titles */
        }

        #artist-name {
            font-size: 1.1em; /* Adjusted artist name size */
            color: #b0b0b0; /* Subtler artist name */
            margin-top: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>

    <div class="widget-container">
        <div id="login-section">
            <p>To see what you're listening to, please log in to Spotify.</p>
            <a href="#" id="login-button">Log in with Spotify</a>
        </div>

        <div id="now-playing">
            <img id="album-art" src="" alt="Album Art">
            <p id="track-title"></p>
            <p id="artist-name"></p>
        </div>
    </div>

    <script>
        const clientId = 'd6d3071a35dc4874af1dcf110017ec8d'; // YOUR CLIENT ID HERE
        const redirectUri = 'https://erasmusdev.github.io/FlockersDevHub/Player.html'; // YOUR GITHUB PAGES URL HERE
        const authEndpoint = 'https://accounts.spotify.com/authorize';
        const tokenEndpoint = 'https://accounts.spotify.com/api/token';
        const scope = 'user-read-currently-playing';

        const loginSection = document.getElementById('login-section');
        const nowPlayingSection = document.getElementById('now-playing');
        const trackTitle = document.getElementById('track-title');
        const artistName = document.getElementById('artist-name');
        const albumArt = document.getElementById('album-art');
        const loginButton = document.getElementById('login-button');

        // Function to generate a random string for the code verifier
        const generateRandomString = (length) => {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let text = '';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        };

        // Function to generate a code challenge from the code verifier
        const generateCodeChallenge = async (codeVerifier) => {
            const encoder = new TextEncoder();
            const data = encoder.encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        };

        const urlParams = new URLSearchParams(window.location.search);
        let code = urlParams.get('code');

        if (code) {
            getAccessToken(code);
        } else {
            let accessToken = localStorage.getItem('accessToken');
            
            if (accessToken) {
                loginSection.style.display = 'none';
                nowPlayingSection.style.display = 'block';
                nowPlayingSection.classList.add('visible'); // Add visible class for fade-in
                getCurrentlyPlaying();
                setInterval(getCurrentlyPlaying, 5000); 
            } else {
                loginButton.addEventListener('click', async () => {
                    const verifier = generateRandomString(128);
                    const challenge = await generateCodeChallenge(verifier);

                    localStorage.setItem('code_verifier', verifier);

                    const params = new URLSearchParams({
                        client_id: clientId,
                        response_type: 'code',
                        redirect_uri: redirectUri,
                        scope: scope,
                        code_challenge_method: 'S256',
                        code_challenge: challenge,
                    });

                    window.location.href = `${authEndpoint}?${params.toString()}`;
                });
            }
        }

        async function getAccessToken(authCode) {
            const verifier = localStorage.getItem('code_verifier');
            const body = new URLSearchParams({
                grant_type: 'authorization_code',
                code: authCode,
                redirect_uri: redirectUri,
                client_id: clientId,
                code_verifier: verifier,
            });

            try {
                const response = await fetch(tokenEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: body,
                });

                if (!response.ok) {
                    throw new Error('HTTP status ' + response.status);
                }

                const data = await response.json();
                localStorage.setItem('accessToken', data.access_token);
                localStorage.setItem('refreshToken', data.refresh_token);
                window.history.replaceState({}, document.title, redirectUri); // Clean up the URL
                location.reload(); 
            } catch (error) {
                console.error('Error fetching access token:', error);
            }
        }

        async function getCurrentlyPlaying() {
            let accessToken = localStorage.getItem('accessToken');
            if (!accessToken) {
                localStorage.clear();
                location.reload();
                return;
            }

            try {
                const response = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                if (response.status === 204) {
                    trackTitle.innerText = "Nothing playing right now.";
                    artistName.innerText = "";
                    albumArt.style.display = "none";
                    return;
                }

                if (response.status === 401) {
                    localStorage.clear();
                    location.reload(); 
                    return;
                }

                const data = await response.json();
                if (data.item) {
                    trackTitle.innerText = data.item.name;
                    artistName.innerText = data.item.artists.map(artist => artist.name).join(', ');
                    albumArt.src = data.item.album.images[0].url;
                    albumArt.style.display = "block";
                    nowPlayingSection.classList.add('visible'); // Ensure visible on updates
                } else {
                    trackTitle.innerText = "Nothing playing right now.";
                    artistName.innerText = "";
                    albumArt.style.display = "none";
                }
            } catch (error) {
                console.error("Error fetching currently playing track:", error);
            }
        }
    </script>
</body>
</html>